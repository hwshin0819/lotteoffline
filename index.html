<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•˜ì´ë§ˆíŠ¸ ì˜ì—… íƒ€ê²ŸíŒ… (ìµœì¢… ìˆ˜ì •)</title>
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=nrjjvl8zmx"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --himart-color: #E30613;
            --apt-color: #F39C12;
            --agent-color: #007bff; /* ìš”ì²­í•˜ì‹  íŒŒë€ìƒ‰ */
            --bg-color: #f8f9fa;
        }

        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Pretendard', sans-serif; overflow: hidden; background: #f8f9fa; }
        
        /* 1. ì§€ë„ ì˜ì—­ */
        .map-container { flex: 3; position: relative; height: 100%; border-right: 1px solid #ddd; }
        #map { width: 100%; height: 100%; }

        /* 2. ìš°ì¸¡ íŒ¨ë„ */
        .sidebar {
            flex: 1; min-width: 350px; background: white;
            display: flex; flex-direction: column; z-index: 2;
        }

        .sidebar-header {
            padding: 20px; background: #333; color: white;
        }
        .sidebar-header h2 { margin: 0 0 5px 0; font-size: 18px; }
        .sidebar-header p { margin: 0; font-size: 12px; opacity: 0.8; }

        .filter-section {
            padding: 15px; background: #f1f3f5; border-bottom: 1px solid #ddd;
        }
        
        /* ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
        .select-group { display: flex; gap: 5px; margin-bottom: 10px; }
        select {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;
            font-size: 14px; background: white;
        }

        /* ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
        .list-header {
            padding: 10px 15px; font-weight: bold; font-size: 13px; color: #555;
            border-bottom: 1px solid #eee; display: flex; justify-content: space-between;
        }

        #targetList { flex: 1; overflow-y: auto; padding: 0; margin: 0; }
        #targetList li {
            list-style: none; padding: 15px; border-bottom: 1px solid #eee;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        #targetList li:hover { background: #f8f9fa; }
        #targetList li.active { background: #e7f5ff; border-left: 4px solid #007bff; }

        .rank-badge {
            position: absolute; top: 15px; right: 15px;
            background: #666; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;
        }
        .rank-badge.top { background: #E30613; } /* ìƒìœ„ê¶Œ ë¹¨ê°„ìƒ‰ */

        /* ì§€ë„ ìœ„ ë²”ë¡€ */
        .legend {
            position: absolute; top: 20px; left: 20px;
            background: white; padding: 12px 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15); z-index: 100; font-size: 12px;
        }
        .legend-row { display: flex; align-items: center; margin-bottom: 6px; }
        .legend-row:last-child { margin-bottom: 0; }
        .dot { width: 12px; height: 12px; margin-right: 8px; border-radius: 50%; }

        /* ì»¤ìŠ¤í…€ ë§ˆì»¤ìš© CSS */
        .marker-pin {
            width: 30px; height: 30px; border-radius: 50% 50% 50% 0;
            background: #007bff; position: absolute; transform: rotate(-45deg);
            left: 50%; top: 50%; margin: -15px 0 0 -15px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3); border: 2px solid white;
        }
        .marker-pin::after {
            content: ''; width: 10px; height: 10px; margin: 8px 0 0 8px;
            background: #fff; position: absolute; border-radius: 50%;
        }

        /* ì •ë³´ì°½ ìŠ¤íƒ€ì¼ */
        .iw_inner {
            padding: 15px; min-width: 280px; background: white;
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #ccc;
        }
        .iw_title { font-weight: bold; font-size: 16px; margin-bottom: 8px; color: #007bff; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .iw_content { font-size: 13px; line-height: 1.6; color: #333; }

        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
    </style>
</head>
<body>

    <div id="loading">
        <h3 style="margin-bottom:10px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h3>
        <p style="font-size:12px; color:#666;">ì¤‘ê°œì‚¬ë¬´ì†Œ ë° ì…ì£¼ë‹¨ì§€ ì¢Œí‘œ ë³€í™˜ ì¤‘</p>
    </div>

    <div class="map-container">
        <div id="map"></div>
        
        <div class="legend">
            <div class="legend-row">
                <div class="dot" style="background:#007bff; border-radius:0; transform:rotate(45deg);"></div>
                <strong>ì¤‘ê°œì‚¬ë¬´ì†Œ (í•µì‹¬íƒ€ê²Ÿ)</strong>
            </div>
            <div class="legend-row">
                <div class="dot" style="background:#F39C12;"></div>
                ì…ì£¼ë‹¨ì§€ (ì„¸ëŒ€ìˆ˜ ë­í‚¹)
            </div>
            <div class="legend-row">
                <div class="dot" style="background:#E30613;"></div>
                í•˜ì´ë§ˆíŠ¸
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>ì˜ì—… íƒ€ê²Ÿ ëŒ€ì‹œë³´ë“œ</h2>
            <p>ì‹œ/êµ°/êµ¬ í•„í„° ë° ì„¸ëŒ€ìˆ˜ ë­í‚¹</p>
        </div>
        
        <div class="filter-section">
            <label style="font-size:12px; font-weight:bold; color:#555; display:block; margin-bottom:5px;">ì§€ì—­ í•„í„°</label>
            <div class="select-group">
                <select id="sidoFilter" onchange="app.onSidoChange()">
                    <option value="">ì‹œ/ë„ ì „ì²´</option>
                </select>
                <select id="sigunguFilter" onchange="app.filterData()">
                    <option value="">ì‹œ/êµ°/êµ¬ ì „ì²´</option>
                </select>
            </div>
            
            <label style="font-size:12px; font-weight:bold; color:#555; display:block; margin-bottom:5px; margin-top:10px;">ê²€ìƒ‰</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="searchInput" placeholder="ì•„íŒŒíŠ¸ëª…, ì¤‘ê°œì‚¬ëª…" 
                       style="padding:10px; width:100%; border:1px solid #ccc; border-radius:4px;"
                       onkeyup="if(event.key==='Enter') app.filterData()">
                <button onclick="app.filterData()" style="width:60px; background:#444; color:white; border:none; border-radius:4px; cursor:pointer;">ì´ë™</button>
            </div>
        </div>

        <div class="list-header">
            <span>ì…ì£¼ë‹¨ì§€ ë¦¬ìŠ¤íŠ¸ (ì„¸ëŒ€ìˆ˜ ìˆœ)</span>
            <span id="resultCount" style="color:#007bff;">0ê³³</span>
        </div>
        
        <ul id="targetList">
            </ul>
    </div>

    <script>
        // âœ… ë°ì´í„° ë§í¬
        const URLS = {
            himart: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=0&single=true&output=csv',
            apt: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=412812614&single=true&output=csv', 
            agent: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=222467253&single=true&output=csv'
        };

        class App {
            constructor() {
                this.map = null;
                this.data = { himart: [], apt: [], agent: [] };
                this.markers = []; // ì „ì²´ ë§ˆì»¤ ê´€ë¦¬
                this.infoWindow = null;

                this.initMap();
                this.loadAllData();
            }

            initMap() {
                this.map = new naver.maps.Map('map', {
                    center: new naver.maps.LatLng(37.5665, 126.9780),
                    zoom: 11,
                    scaleControl: true,
                    logoControl: false
                });

                this.infoWindow = new naver.maps.InfoWindow({
                    borderWidth: 0, backgroundColor: "transparent", anchorSkew: true
                });

                // ì§€ë„ í´ë¦­ ì‹œ ì •ë³´ì°½ ë‹«ê¸°
                naver.maps.Event.addListener(this.map, 'click', () => {
                    this.infoWindow.close();
                });
            }

            async loadAllData() {
                try {
                    const [h, a, g] = await Promise.all([
                        this.fetchCSV(URLS.himart),
                        this.fetchCSV(URLS.apt),
                        this.fetchCSV(URLS.agent)
                    ]);
                    
                    this.data = { himart: h, apt: a, agent: g };
                    console.log(`ë°ì´í„° ë¡œë“œ: í•˜ì´ë§ˆíŠ¸(${h.length}), ì•„íŒŒíŠ¸(${a.length}), ì¤‘ê°œì‚¬(${g.length})`);
                    
                    this.initFilters(); // í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
                    this.filterData(); // ë°ì´í„° ê·¸ë¦¬ê¸°
                    
                    document.getElementById('loading').style.display = 'none';
                } catch (e) {
                    alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + e.message);
                }
            }

            fetchCSV(url) {
                return new Promise(resolve => {
                    Papa.parse(url, {
                        download: true, 
                        header: true, 
                        skipEmptyLines: true,
                        transformHeader: h => h.trim(), // í—¤ë” ê³µë°± ì œê±° (ë§¤ìš° ì¤‘ìš”!)
                        complete: res => resolve(res.data)
                    });
                });
            }

            // ì¢Œí‘œ ì¶”ì¶œ (ì•ˆì „ì¥ì¹˜ ì¶”ê°€)
            getPos(item) {
                // í—¤ë”ê°€ 'ìœ„ë„', 'ê²½ë„' í˜¹ì€ 'Yì¢Œí‘œ', 'Xì¢Œí‘œ' ì¸ì§€ í™•ì¸í•˜ê³  ìˆ«ìë¡œ ë³€í™˜
                const lat = parseFloat(item['ìœ„ë„'] || item['Yì¢Œí‘œ']);
                const lng = parseFloat(item['ê²½ë„'] || item['Xì¢Œí‘œ']);
                
                if (!isNaN(lat) && !isNaN(lng) && lat > 30 && lng > 120) {
                    return new naver.maps.LatLng(lat, lng);
                }
                return null;
            }

            // ì‹œ/ë„, ì‹œ/êµ°/êµ¬ í•„í„° ì±„ìš°ê¸°
            initFilters() {
                const sidoSet = new Set();
                this.data.apt.forEach(d => { if(d['ì‹œë„']) sidoSet.add(d['ì‹œë„']); });
                
                const sidoSelect = document.getElementById('sidoFilter');
                [...sidoSet].sort().forEach(sido => {
                    const opt = document.createElement('option');
                    opt.value = sido; opt.innerText = sido;
                    sidoSelect.appendChild(opt);
                });
            }

            onSidoChange() {
                const selectedSido = document.getElementById('sidoFilter').value;
                const sigunguSelect = document.getElementById('sigunguFilter');
                sigunguSelect.innerHTML = '<option value="">ì‹œ/êµ°/êµ¬ ì „ì²´</option>';
                
                if (!selectedSido) {
                    this.filterData();
                    return;
                }

                // í•´ë‹¹ ì‹œë„ì˜ ì‹œêµ°êµ¬ë§Œ ì¶”ì¶œ
                const sigunguSet = new Set();
                this.data.apt.forEach(d => {
                    if (d['ì‹œë„'] === selectedSido && d['ì‹œêµ°êµ¬']) { // ì‹œêµ°êµ¬ í—¤ë”ê°€ 'ì£¼ì†Œ'ì— í¬í•¨ëœ ê²½ìš° íŒŒì‹± í•„ìš”í• ìˆ˜ë„ ìˆìŒ
                        // ì—¬ê¸°ì„œëŠ” ë°ì´í„°ì— 'ì‹œêµ°êµ¬' ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ 'ì£¼ì†Œ'ì—ì„œ ì¶”ì¶œ
                        let sigungu = d['ì‹œêµ°êµ¬'];
                        if(!sigungu && d['ì£¼ì†Œ']) {
                            const parts = d['ì£¼ì†Œ'].split(' ');
                            if(parts.length > 1) sigungu = parts[1];
                        }
                        if(sigungu) sigunguSet.add(sigungu);
                    }
                });

                [...sigunguSet].sort().forEach(gu => {
                    const opt = document.createElement('option');
                    opt.value = gu; opt.innerText = gu;
                    sigunguSelect.appendChild(opt);
                });

                this.filterData();
            }

            // ë°ì´í„° í•„í„°ë§ ë° ë Œë”ë§ (í•µì‹¬ ë¡œì§)
            filterData() {
                const sido = document.getElementById('sidoFilter').value;
                const sigungu = document.getElementById('sigunguFilter').value;
                const keyword = document.getElementById('searchInput').value.toLowerCase();

                // 1. ì•„íŒŒíŠ¸ í•„í„°ë§ & ì •ë ¬ (ì„¸ëŒ€ìˆ˜ ë­í‚¹)
                const filteredApt = this.data.apt.filter(item => {
                    const addr = (item['ì£¼ì†Œ'] || '').toLowerCase();
                    const itemSido = item['ì‹œë„'] || '';
                    const matchSido = sido ? (itemSido === sido || addr.includes(sido)) : true;
                    const matchSigungu = sigungu ? addr.includes(sigungu) : true;
                    const matchKey = keyword ? (item['ì£¼íƒëª…']||'').toLowerCase().includes(keyword) : true;
                    return matchSido && matchSigungu && matchKey;
                }).sort((a, b) => {
                    // ì„¸ëŒ€ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                    const sizeA = parseInt((a['ì„¸ëŒ€ìˆ˜']||'0').replace(/,/g,''));
                    const sizeB = parseInt((b['ì„¸ëŒ€ìˆ˜']||'0').replace(/,/g,''));
                    return sizeB - sizeA;
                });

                // 2. ì¤‘ê°œì‚¬ í•„í„°ë§ (ì§€ì—­ ê¸°ì¤€)
                const filteredAgent = this.data.agent.filter(item => {
                    const addr = (item['ì „ì²´ ì£¼ì†Œ'] || '').toLowerCase();
                    const matchSido = sido ? addr.includes(sido) : true;
                    const matchSigungu = sigungu ? addr.includes(sigungu) : true;
                    // ê²€ìƒ‰ì–´ ìˆìœ¼ë©´ ì¤‘ê°œì‚¬ëª…ë„ ê²€ìƒ‰
                    const matchKey = keyword ? (item['ì¤‘ê°œì—…ì†Œëª…']||'').toLowerCase().includes(keyword) : true;
                    return matchSido && matchSigungu && matchKey;
                });

                // 3. ì§€ë„ ì—…ë°ì´íŠ¸
                this.updateMap(filteredApt, filteredAgent);
                
                // 4. ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ì•„íŒŒíŠ¸ ë­í‚¹)
                this.updateList(filteredApt);
            }

            updateMap(apts, agents) {
                // ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
                this.markers.forEach(m => m.setMap(null));
                this.markers = [];
                const bounds = new naver.maps.LatLngBounds();

                // 1. í•˜ì´ë§ˆíŠ¸ (í•­ìƒ í‘œì‹œí•˜ë˜, íˆ¬ëª…í•˜ê²Œ)
                this.data.himart.forEach(item => {
                    const pos = this.getPos(item);
                    if(!pos) return;
                    new naver.maps.Circle({
                        map: this.map, center: pos, radius: 2000,
                        fillColor: '#E30613', fillOpacity: 0.05, strokeColor: 'transparent', clickable: false
                    });
                    const m = new naver.maps.Marker({
                        position: pos, map: this.map,
                        icon: {
                            content: '<div style="background:#E30613; width:10px; height:10px; border-radius:50%; box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>'
                        }
                    });
                    // í•˜ì´ë§ˆíŠ¸ í´ë¦­ ì´ë²¤íŠ¸
                    naver.maps.Event.addListener(m, 'click', () => {
                        this.showInfo('himart', item, m);
                    });
                    this.markers.push(m);
                });

                // 2. ì•„íŒŒíŠ¸ (ì£¼í™©ìƒ‰ ì )
                apts.forEach(item => {
                    const pos = this.getPos(item);
                    if(!pos) return;
                    
                    const m = new naver.maps.Marker({
                        position: pos, map: this.map,
                        icon: {
                            content: '<div style="background:#F39C12; width:14px; height:14px; border-radius:50%; border:1px solid white; box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>'
                        }
                    });
                    naver.maps.Event.addListener(m, 'click', () => {
                        this.showInfo('apt', item, m);
                        this.map.panTo(pos);
                    });
                    this.markers.push(m);
                    bounds.extend(pos);
                });

                // 3. ì¤‘ê°œì‚¬ (íŒŒë€ í•€ - ì¤‘ìš”!!)
                agents.forEach(item => {
                    const pos = this.getPos(item);
                    if(!pos) return;
                    
                    const m = new naver.maps.Marker({
                        position: pos, map: this.map, zIndex: 100,
                        icon: {
                            content: '<div class="marker-pin"></div>', // íŒŒë€ í•€ ìŠ¤íƒ€ì¼
                            anchor: new naver.maps.Point(15, 30)
                        }
                    });
                    
                    naver.maps.Event.addListener(m, 'click', () => {
                        this.showInfo('agent', item, m);
                        this.map.panTo(pos);
                    });
                    this.markers.push(m);
                    // ì¤‘ê°œì‚¬ë„ ì§€ë„ ë²”ìœ„ì— í¬í•¨
                    bounds.extend(pos);
                });

                // ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì§€ë„ ì´ë™
                if(apts.length > 0 || agents.length > 0) {
                    this.map.fitBounds(bounds);
                }
            }

            showInfo(type, data, marker) {
                let html = '';
                if(type === 'agent') {
                    html = `
                        <div class="iw_inner">
                            <div class="iw_title">${data['ì¤‘ê°œì—…ì†Œëª…'] || 'ìƒí˜¸ëª… ì—†ìŒ'}</div>
                            <div class="iw_content">
                                <div>ğŸ“ ${data['ì „ì²´ ì£¼ì†Œ']}</div>
                                <div style="margin-top:5px;">ğŸ“ <a href="tel:${data['ì—°ë½ì²˜']}">${data['ì—°ë½ì²˜']}</a></div>
                                <div style="margin-top:5px; font-weight:bold; color:#007bff;">ğŸ‘¤ ë‹´ë‹¹ì: ${data['ì„±í•¨'] || 'ë¯¸ì •'}</div>
                            </div>
                        </div>
                    `;
                } else if(type === 'apt') {
                    html = `
                        <div class="iw_inner">
                            <div class="iw_title" style="color:#F39C12; border-color:#F39C12;">${data['ì£¼íƒëª…']}</div>
                            <div class="iw_content">
                                <div>ğŸ  ${data['ì„¸ëŒ€ìˆ˜']}ì„¸ëŒ€ (${data['ì—°ì›”']})</div>
                                <div style="margin-top:5px; font-size:12px; color:#666;">${data['ì£¼ì†Œ']}</div>
                            </div>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="iw_inner">
                            <div class="iw_title" style="color:#E30613; border-color:#E30613;">${data['ì§€ì ëª…']}</div>
                            <div class="iw_content">ğŸ“ ${data['ì£¼ì†Œ']}</div>
                        </div>
                    `;
                }
                
                this.infoWindow.setContent(html);
                this.infoWindow.open(this.map, marker);
            }

            updateList(apts) {
                const list = document.getElementById('targetList');
                const count = document.getElementById('resultCount');
                list.innerHTML = '';
                count.innerText = `${apts.length}ê³³`;

                // ìƒìœ„ 50ê°œë§Œ í‘œì‹œ (ì†ë„ ìµœì í™”)
                apts.slice(0, 50).forEach((item, index) => {
                    const li = document.createElement('li');
                    const size = item['ì„¸ëŒ€ìˆ˜'] || '0';
                    
                    li.innerHTML = `
                        <div style="font-weight:bold; font-size:15px; margin-bottom:5px;">${item['ì£¼íƒëª…']}</div>
                        <div style="font-size:13px; color:#666;">
                            <span>${size}ì„¸ëŒ€</span> <span style="margin:0 5px;">|</span> <span>${item['ì—°ì›”']}</span>
                        </div>
                        <div style="font-size:12px; color:#999; margin-top:5px;">${item['ì£¼ì†Œ']}</div>
                        <span class="rank-badge ${index < 3 ? 'top' : ''}">${index + 1}ìœ„</span>
                    `;
                    
                    li.onclick = () => {
                        const pos = this.getPos(item);
                        if(pos) {
                            this.map.panTo(pos);
                            this.map.setZoom(16, true); // ì¤Œì¸
                            
                            // ë¦¬ìŠ¤íŠ¸ í™œì„±í™” í‘œì‹œ
                            document.querySelectorAll('#targetList li').forEach(el => el.classList.remove('active'));
                            li.classList.add('active');
                        }
                    };
                    list.appendChild(li);
                });
            }
        }

        const app = new App();
    </script>
</body>
</html>
