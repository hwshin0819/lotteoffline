<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡­í‹°ì–´-í•˜ì´ë§ˆíŠ¸ ì˜¤í”„ë¼ì¸</title>
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=nrjjvl8zmx"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #333;
            --himart-color: #E30613;
            --apt-color: #007bff;
            --agent-color: #28a745;
            --background-color: #e9ecef;
            --border-radius: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            flex: 3;
            padding: 20px;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        h1 { margin-bottom: 10px; font-size: 24px; }

        #map {
            flex: 1;
            width: 100%;
            margin-top: 10px;
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
        }

        .filter-panel {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            border-left: 2px solid #dee2e6;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            overflow-y: hidden;
        }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .container { flex: none; height: 500px; }
            .filter-panel { flex: none; }
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #f0f0f0;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        button:hover { background-color: #e0e0e0; }
        button.active { background-color: #333; color: white; }

        #resultCount { margin: 15px 0 5px 0; font-weight: bold; font-size: 14px; color: #666; }
        
        #targetList {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            margin-top: 10px;
        }

        #targetList li {
            list-style: none;
            padding: 15px;
            border-radius: var(--border-radius);
            background: white;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            border-left: 4px solid transparent;
        }

        #targetList li:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-left-color: var(--apt-color);
        }

        .filter-section { padding: 15px 0; }
        .filter-section label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }

        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .badge {
            display: inline-block;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            margin-right: 4px;
        }

        .loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95); padding: 30px;
            border-radius: var(--border-radius); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none; z-index: 1000; text-align: center; font-weight: bold;
        }
        
        .map-legend {
            position: absolute; top: 80px; left: 40px;
            background: white; padding: 12px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100; font-size: 12px;
        }
        .legend-row { display: flex; align-items: center; margin-bottom: 5px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        
        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ */
        .toggle-container { display: flex; align-items: center; margin-top: 10px; font-size: 14px;}
        .toggle-container input { width: auto; margin-right: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center;">í•˜ì´ë§ˆíŠ¸ ì œíœ´ ì˜ì—… íƒ€ê²ŸíŒ…<br><span style="font-size: 0.8rem; color: #666;">(ë§¤ì¥ Â· ì…ì£¼ë‹¨ì§€ Â· ì¤‘ê°œì‚¬)</span></h1>
        
        <div style="text-align: center;">
            <button id="refreshData">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div id="map"></div>
        
        <div class="map-legend">
            <div class="legend-row"><div class="dot" style="background:var(--himart-color)"></div>í•˜ì´ë§ˆíŠ¸ (ë°˜ê²½ 2km)</div>
            <div class="legend-row"><div class="dot" style="background:var(--apt-color)"></div>ì…ì£¼ ì˜ˆì • ë‹¨ì§€</div>
            <div class="legend-row"><div class="dot" style="background:var(--agent-color)"></div>ì¤‘ê°œì‚¬ë¬´ì†Œ (í´ë¦­í•˜ì—¬ ì •ë³´í™•ì¸)</div>
        </div>

        <div id="loading" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>
    </div>

    <div class="filter-panel">
        <h3>í•„í„° & íƒ€ê²Ÿ ë¦¬ìŠ¤íŠ¸</h3>
        
        <div class="filter-section">
            <label>ë³´ê¸° ì˜µì…˜:</label>
            <div class="toggle-container">
                <input type="checkbox" id="showAgents" checked> ì¤‘ê°œì‚¬ë¬´ì†Œ ì§€ë„ì— í‘œì‹œí•˜ê¸°
            </div>
            <div style="font-size:12px; color:#666; margin-top:4px;">* ì¤‘ê°œì‚¬ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì²´í¬ë¥¼ í•´ì œí•˜ì„¸ìš”.</div>
        </div>

        <div class="filter-section">
            <label>ì…ì£¼ë‹¨ì§€ ê·œëª¨:</label>
            <select id="sizeFilter">
                <option value="0">ì „ì²´ ë³´ê¸°</option>
                <option value="500">500ì„¸ëŒ€ ì´ìƒ</option>
                <option value="1000">1000ì„¸ëŒ€ ì´ìƒ (ëŒ€ë‹¨ì§€)</option>
            </select>
        </div>

        <div class="filter-section">
            <label>ê²€ìƒ‰ (ì•„íŒŒíŠ¸/ì§€ì—­ëª…):</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="searchInput" placeholder="ì˜ˆ: ìì´, ê°•ë‚¨êµ¬">
                <button onclick="MapController.getInstance().filterData()" style="padding:8px;">ğŸ”</button>
            </div>
        </div>

        <p id="resultCount">íƒ€ê²Ÿ ë‹¨ì§€: 0ê³³</p>
        <ul id="targetList"></ul>
    </div>

    <script>
        const URLS = {
            himart: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=0&single=true&output=csv',
            apt: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=412812614&single=true&output=csv', 
            agent: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=222467253&single=true&output=csv'
        };

        class MapController {
            static instance = null;
            
            constructor() {
                this.map = null;
                this.data = { himart: [], apt: [], agent: [] };
                this.markers = [];
                this.agentMarkers = []; // ì¤‘ê°œì‚¬ ë§ˆì»¤ ë³„ë„ ê´€ë¦¬
                this.circles = [];
                this.infoWindow = null;

                this.initializeMap();
            }

            static getInstance() {
                if (!MapController.instance) MapController.instance = new MapController();
                return MapController.instance;
            }

            async initializeMap() {
                try {
                    this.initMap();
                    this.initEventListeners();
                    await this.loadAllData();
                } catch (error) {
                    console.error(error);
                }
            }

            initMap() {
                this.map = new naver.maps.Map('map', {
                    center: new naver.maps.LatLng(37.5665, 126.9780),
                    zoom: 11,
                    minZoom: 7,
                    scaleControl: true,
                    mapDataControl: false,
                    zoomControl: true,
                    zoomControlOptions: { position: naver.maps.Position.TOP_RIGHT }
                });

                this.infoWindow = new naver.maps.InfoWindow({
                    maxWidth: 300,
                    backgroundColor: "#fff",
                    borderColor: "#ccc",
                    borderWidth: 1,
                    anchorSize: new naver.maps.Size(10, 10),
                    anchorSkew: true
                });
                
                // ì§€ë„ í´ë¦­ì‹œ ì •ë³´ì°½ ë‹«ê¸°
                naver.maps.Event.addListener(this.map, 'click', () => {
                    this.infoWindow.close();
                });
            }

            initEventListeners() {
                document.getElementById('refreshData').addEventListener('click', () => this.loadAllData());
                document.getElementById('sizeFilter').addEventListener('change', () => this.filterData());
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if(e.key === 'Enter') this.filterData();
                });
                // ì¤‘ê°œì‚¬ í† ê¸€ ë²„íŠ¼
                document.getElementById('showAgents').addEventListener('change', (e) => {
                    this.toggleAgentMarkers(e.target.checked);
                });
            }

            async loadAllData() {
                this.showLoading(true);
                try {
                    const results = await Promise.all([
                        this.fetchCSV(URLS.himart),
                        this.fetchCSV(URLS.apt),
                        this.fetchCSV(URLS.agent)
                    ]);

                    this.data.himart = results[0];
                    this.data.apt = results[1];
                    this.data.agent = results[2];

                    console.log("ë°ì´í„° ë¡œë“œ ì™„ë£Œ. ê°œìˆ˜ í™•ì¸:", 
                        "í•˜ì´ë§ˆíŠ¸:", this.data.himart.length, 
                        "ì…ì£¼ë‹¨ì§€:", this.data.apt.length, 
                        "ì¤‘ê°œì‚¬:", this.data.agent.length);

                    this.renderMapItems();
                    this.filterData(); // ì´ˆê¸° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                } catch (error) {
                    alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            fetchCSV(url) {
                return new Promise((resolve, reject) => {
                    Papa.parse(url, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (res) => resolve(res.data),
                        error: (err) => reject(err)
                    });
                });
            }

            // ì¢Œí‘œ ì°¾ê¸° í—¬í¼ í•¨ìˆ˜ (ì¤‘ìš”!)
            getLatLng(item) {
                // ìœ„ë„/ê²½ë„ í˜¹ì€ Yì¢Œí‘œ/Xì¢Œí‘œ ë‘˜ ë‹¤ ì²´í¬
                const lat = item['ìœ„ë„'] || item['Yì¢Œí‘œ'] || item['lat'];
                const lng = item['ê²½ë„'] || item['Xì¢Œí‘œ'] || item['lng'];
                
                if (lat && lng) {
                    return new naver.maps.LatLng(lat, lng);
                }
                return null;
            }

            renderMapItems() {
                // ì´ˆê¸°í™”
                this.markers.forEach(m => m.setMap(null));
                this.agentMarkers.forEach(m => m.setMap(null));
                this.circles.forEach(c => c.setMap(null));
                this.markers = [];
                this.agentMarkers = [];
                this.circles = [];

                const bounds = new naver.maps.LatLngBounds();

                // 1. í•˜ì´ë§ˆíŠ¸ & ë°˜ê²½
                this.data.himart.forEach(item => {
                    const pos = this.getLatLng(item);
                    if(!pos) return;
                    
                    this.createMarker(pos, 'himart', item);
                    const circle = new naver.maps.Circle({
                        map: this.map,
                        center: pos,
                        radius: 2000,
                        fillColor: '#E30613',
                        fillOpacity: 0.05,
                        strokeColor: '#E30613',
                        strokeOpacity: 0.3,
                        strokeWeight: 1,
                        clickable: false
                    });
                    this.circles.push(circle);
                    bounds.extend(pos);
                });

                // 2. ì…ì£¼ë‹¨ì§€
                this.data.apt.forEach(item => {
                    const pos = this.getLatLng(item);
                    if(!pos) return;
                    this.createMarker(pos, 'apt', item);
                });

                // 3. ì¤‘ê°œì‚¬ (ë³„ë„ ë°°ì—´ì— ì €ì¥)
                this.data.agent.forEach(item => {
                    const pos = this.getLatLng(item);
                    if(!pos) return;
                    this.createMarker(pos, 'agent', item);
                });

                if(this.data.himart.length > 0) this.map.fitBounds(bounds);
            }

            createMarker(position, type, data) {
                let zIndex, contentHTML, targetArray;

                if(type === 'himart') {
                    zIndex = 100;
                    targetArray = this.markers;
                    contentHTML = `<div style="background:#E30613; width:24px; height:24px; border-radius:50%; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3); text-align:center; color:white; font-weight:bold; font-size:13px; line-height:20px;">H</div>`;
                } else if (type === 'apt') {
                    zIndex = 110;
                    targetArray = this.markers;
                    const size = parseInt((data['ì„¸ëŒ€ìˆ˜']||'0').replace(/,/g, ''));
                    const isBig = size >= 1000;
                    const width = isBig ? 24 : 18;
                    const border = isBig ? '3px solid white' : '2px solid white';
                    // ëŒ€ë‹¨ì§€ëŠ” íŒŒë€ìƒ‰, ì¼ë°˜ì€ í•˜ëŠ˜ìƒ‰
                    const color = isBig ? '#0056b3' : '#007bff';
                    contentHTML = `<div style="background:${color}; width:${width}px; height:${width}px; transform:rotate(45deg); border:${border}; box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>`;
                } else {
                    // ì¤‘ê°œì‚¬
                    zIndex = 90;
                    targetArray = this.agentMarkers; // ì¤‘ê°œì‚¬ëŠ” ë³„ë„ ê´€ë¦¬
                    // ì´ˆë¡ìƒ‰ ì ì„ ì¢€ ë” í‚¤ì›Œì„œ ì˜ ë³´ì´ê²Œ í•¨ (8px -> 12px)
                    contentHTML = `<div style="background:#28a745; width:12px; height:12px; border-radius:50%; border:1px solid white; box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>`;
                }

                const marker = new naver.maps.Marker({
                    position: position,
                    map: this.map,
                    zIndex: zIndex,
                    icon: { content: contentHTML, anchor: new naver.maps.Point(12, 12) }
                });

                naver.maps.Event.addListener(marker, 'click', () => {
                    this.showInfoWindow(marker, type, data);
                });

                targetArray.push(marker);
            }

            showInfoWindow(marker, type, data) {
                let content = '<div style="padding:15px; min-width:220px; font-family:sans-serif;">';
                
                if(type === 'himart') {
                    content += `<h3 style="color:#E30613; margin:0 0 5px 0;">${data['ì§€ì ëª…']}</h3>`;
                    content += `<p style="font-size:13px;">${data['ì£¼ì†Œ']}</p>`;
                } else if(type === 'apt') {
                    content += `<h3 style="color:#007bff; margin:0 0 5px 0;">${data['ì£¼íƒëª…']}</h3>`;
                    content += `<p style="margin:5px 0;">ğŸ  <b>${data['ì„¸ëŒ€ìˆ˜']}ì„¸ëŒ€</b> | ${data['ì—°ì›”']}</p>`;
                    content += `<div style="background:#f1f3f5; padding:8px; border-radius:4px; font-size:12px;">ë§¤ë§¤ ${data['ë§¤ë§¤']} / ì „ì„¸ ${data['ì „ì„¸']}</div>`;
                    content += `<p style="font-size:12px; color:#888; margin-top:5px;">${data['ì£¼ì†Œ']}</p>`;
                } else {
                    // ì¤‘ê°œì‚¬ ì •ë³´ (ë¡ ì•¤ë¹„ì¦ˆ ìŠ¤íƒ€ì¼)
                    content += `<h3 style="color:#28a745; margin:0 0 5px 0;">${data['ì¤‘ê°œì—…ì†Œëª…']}</h3>`;
                    content += `<p style="font-size:14px; font-weight:bold; margin-bottom:5px;">ğŸ‘¤ ${data['ì„±í•¨']} ëŒ€í‘œ</p>`;
                    content += `<p style="margin-bottom:5px;"><a href="tel:${data['ì—°ë½ì²˜']}" style="color:#333; text-decoration:none; border-bottom:1px dashed #999;">ğŸ“ ${data['ì—°ë½ì²˜']}</a></p>`;
                    content += `<p style="font-size:12px; color:#888;">${data['ì „ì²´ ì£¼ì†Œ']}</p>`;
                }
                content += '</div>';

                this.infoWindow.setContent(content);
                this.infoWindow.open(this.map, marker);
            }

            toggleAgentMarkers(show) {
                this.agentMarkers.forEach(m => m.setMap(show ? this.map : null));
            }

            filterData() {
                const minSize = parseInt(document.getElementById('sizeFilter').value);
                const keyword = document.getElementById('searchInput').value.toLowerCase();
                
                const filteredApts = this.data.apt.filter(item => {
                    const size = parseInt((item['ì„¸ëŒ€ìˆ˜'] || '0').replace(/,/g, '')) || 0;
                    const name = (item['ì£¼íƒëª…'] || '').toLowerCase();
                    const addr = (item['ì£¼ì†Œ'] || '').toLowerCase();
                    const sizeMatch = size >= minSize;
                    const keywordMatch = keyword === '' || name.includes(keyword) || addr.includes(keyword);
                    return sizeMatch && keywordMatch;
                });

                this.updateList(filteredApts);
            }

            updateList(data) {
                const listEl = document.getElementById('targetList');
                const countEl = document.getElementById('resultCount');
                listEl.innerHTML = '';
                countEl.innerText = `íƒ€ê²Ÿ ë‹¨ì§€: ${data.length}ê³³`;

                const displayData = data.slice(0, 100);

                displayData.forEach(item => {
                    const li = document.createElement('li');
                    const size = parseInt((item['ì„¸ëŒ€ìˆ˜'] || '0').replace(/,/g, ''));
                    let badge = '';
                    if(size >= 1000) badge = `<span class="badge" style="background:#007bff;">ëŒ€ë‹¨ì§€</span>`;

                    li.innerHTML = `
                        <div style="font-weight:bold; font-size:15px; margin-bottom:5px; color:#333;">${badge} ${item['ì£¼íƒëª…']}</div>
                        <div style="font-size:13px; color:#666;">${item['ì„¸ëŒ€ìˆ˜']}ì„¸ëŒ€ | ${item['ì—°ì›”']}</div>
                        <div style="font-size:12px; color:#999; margin-top:5px;">${item['ì£¼ì†Œ']}</div>
                    `;
                    
                    li.onclick = () => {
                        const pos = this.getLatLng(item);
                        if(pos) {
                            this.map.setCenter(pos);
                            this.map.setZoom(15);
                            document.querySelectorAll('#targetList li').forEach(el => el.style.borderLeftColor = 'transparent');
                            li.style.borderLeftColor = '#007bff';
                        }
                    };
                    listEl.appendChild(li);
                });
            }

            showLoading(show) {
                document.getElementById('loading').style.display = show ? 'block' : 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            MapController.getInstance();
        });
    </script>
</body>
</html>
