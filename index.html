<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡­í‹°ì–´/í•˜ì´ë§ˆíŠ¸ ì˜¤í”„ë¼ì¸</title>
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=nrjjvl8zmx"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --himart-red: #E30613;
            --himart-yellow: #ED6324; /* ì•ˆì‹¬ì¼€ì–´ ì„¼í„° */
            --apt-color: #F39C12;
            --agent-color: #007bff;
        }

        body { margin: 0; padding: 0; display: flex; height: 100vh; width: 100vw; font-family: 'Pretendard', sans-serif; overflow: hidden; background: #f8f9fa; }
        
        .map-container { flex-grow: 1; position: relative; height: 100%; z-index: 1; }
        #map { width: 100%; height: 100%; }

        .sidebar {
            width: 380px; flex-shrink: 0; background: white;
            display: flex; flex-direction: column; z-index: 2;
            border-left: 1px solid #ddd; box-shadow: -2px 0 5px rgba(0,0,0,0.05);
        }

        .sidebar-header { padding: 25px 20px; background: #333; color: white; }
        .sidebar-header h2 { margin: 0 0 5px 0; font-size: 20px; }
        .sidebar-header p { margin: 0; font-size: 13px; opacity: 0.8; color: #ddd; }

        #targetList { flex: 1; overflow-y: auto; padding: 0; margin: 0; }
        #targetList li {
            list-style: none; padding: 15px 20px; border-bottom: 1px solid #eee;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        #targetList li:hover { background: #f8f9fa; }
        #targetList li.active { background: #e7f5ff; border-left: 4px solid #007bff; }

        .rank-badge {
            position: absolute; top: 15px; right: 20px;
            background: #999; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;
        }
        .rank-badge.top { background: #E30613; }

        /* ë²”ë¡€ ìŠ¤íƒ€ì¼ */
        .legend {
            position: absolute; top: 20px; left: 20px;
            background: white; padding: 12px 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15); z-index: 100; font-size: 12px;
        }
        .legend-row { display: flex; align-items: center; margin-bottom: 6px; }
        .dot { width: 12px; height: 12px; margin-right: 8px; border-radius: 50%; }

        .iw_inner {
            padding: 20px; min-width: 280px; background: white;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid #ddd;
        }
        .iw_title { font-weight: bold; font-size: 17px; margin-bottom: 12px; color: #007bff; border-bottom: 2px solid #f1f3f5; padding-bottom: 8px; }
        .iw_row { font-size: 14px; margin-bottom: 6px; color: #333; display: flex; align-items: flex-start; }
        .iw_icon { width: 20px; text-align: center; margin-right: 8px; }

        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
    </style>
</head>
<body>

    <div id="loading">
        <h3 style="margin-bottom:10px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h3>
        <p style="font-size:12px; color:#666;">ì•ˆì‹¬ì¼€ì–´ ì„¼í„° êµ¬ë¶„ ë° ì¢Œí‘œ ìµœì í™” ì¤‘</p>
    </div>

    <div class="map-container">
        <div id="map"></div>
        <div class="legend">
            <div class="legend-row">
                <div class="dot" style="background:#007bff; border:2px solid white; box-shadow:0 1px 3px rgba(0,0,0,0.3); width:14px; height:14px;"></div>
                <strong>ì¤‘ê°œì‚¬ë¬´ì†Œ</strong>
            </div>
            <div class="legend-row">
                <div style="font-size:16px; margin-right:5px;">ğŸ¢</div>
                ì…ì£¼ë‹¨ì§€ (Top 42)
            </div>
            <div class="legend-row"><div class="dot" style="background:#FFD700; border:1px solid #ddd;"></div>í•˜ì´ë§ˆíŠ¸ (ì•ˆì‹¬ì¼€ì–´)</div>
            <div class="legend-row"><div class="dot" style="background:#E30613;"></div>í•˜ì´ë§ˆíŠ¸ (ì¼ë°˜)</div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>ì˜ì—… íƒ€ê²Ÿ ëŒ€ì‹œë³´ë“œ</h2>
            <p>ì „êµ­ ì…ì£¼ë‹¨ì§€ ì„¸ëŒ€ìˆ˜ ìƒìœ„ 42ê³³</p>
        </div>
        
        <div style="padding:15px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; font-size:13px; font-weight:bold; background:#f8f9fa;">
            <span>ìš°ì„ ìˆœìœ„ ë¦¬ìŠ¤íŠ¸</span>
            <span id="resultCount" style="color:#E30613;">42ê³³</span>
        </div>
        
        <ul id="targetList"></ul>
    </div>

    <script>
        const URLS = {
            himart: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=0&single=true&output=csv',
            apt: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=412812614&single=true&output=csv', 
            agent: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=222467253&single=true&output=csv'
        };

        class App {
            constructor() {
                this.map = null;
                this.data = { himart: [], apt: [], agent: [] };
                this.markers = [];
                this.infoWindow = null;
                this.initMap();
                this.loadAllData();
            }

            initMap() {
                this.map = new naver.maps.Map('map', {
                    center: new naver.maps.LatLng(36.5, 127.5),
                    zoom: 7, scaleControl: true
                });
                this.infoWindow = new naver.maps.InfoWindow({
                    borderWidth: 0, backgroundColor: "transparent", anchorSkew: true, anchorSize: new naver.maps.Size(12, 12)
                });
                naver.maps.Event.addListener(this.map, 'click', () => this.infoWindow.close());
            }

            async loadAllData() {
                try {
                    const [h, a, g] = await Promise.all([
                        this.fetchCSV(URLS.himart), this.fetchCSV(URLS.apt), this.fetchCSV(URLS.agent)
                    ]);
                    this.data = { himart: h, apt: a, agent: g };
                    this.processTop42();
                    document.getElementById('loading').style.display = 'none';
                } catch (e) {
                    alert("ë¡œë”© ì‹¤íŒ¨: " + e.message);
                }
            }

            fetchCSV(url) {
                return new Promise(resolve => {
                    Papa.parse(url, {
                        download: true, header: true, skipEmptyLines: true,
                        transformHeader: h => h.trim(),
                        complete: res => resolve(res.data)
                    });
                });
            }

            // ì¢Œí‘œ ìë™ ë³´ì • (í•„ìˆ˜)
            getPos(item) {
                const keys = Object.keys(item);
                let latStr, lngStr;

                // 1. í—¤ë” ì´ë¦„ìœ¼ë¡œ ì°¾ê¸° ì‹œë„
                const latKey = keys.find(k => ['ìœ„ë„','Yì¢Œí‘œ','lat'].some(s => k.includes(s)));
                const lngKey = keys.find(k => ['ê²½ë„','Xì¢Œí‘œ','lng'].some(s => k.includes(s)));
                
                latStr = item[latKey];
                lngStr = item[lngKey];

                if(!latStr || !lngStr) return null;

                let lat = parseFloat(latStr);
                let lng = parseFloat(lngStr);

                if (isNaN(lat) || isNaN(lng)) return null;

                // 2. ì¢Œí‘œ ë’¤ì§‘í˜ ìë™ ë³´ì • (í•œêµ­ ê¸°ì¤€)
                if (lat > 100) { let temp = lat; lat = lng; lng = temp; }
                if (lat > 32 && lat < 43 && lng > 124 && lng < 132) {
                    return new naver.maps.LatLng(lat, lng);
                }
                return null;
            }

            findAddress(item) {
                // ì£¼ì†Œ ê´€ë ¨ í‚¤ ì°¾ê¸° (ì „ì²´ ì£¼ì†Œ, ì£¼ì†Œ, ì†Œì¬ì§€ ë“±)
                const keys = Object.keys(item);
                const addrKey = keys.find(k => k.replace(/\s/g, '').includes('ì£¼ì†Œ') || k.includes('ì†Œì¬ì§€'));
                if (addrKey && item[addrKey]) return item[addrKey];
                // ì—†ìœ¼ë©´ ê·¸ëƒ¥ ê°’ì˜ ê¸¸ì´ê°€ ê¸´ ê²ƒ ì¤‘ í•˜ë‚˜ (íœ´ë¦¬ìŠ¤í‹±)
                return Object.values(item).find(v => v.length > 10 && (v.includes('ì‹œ') || v.includes('ë„'))) || 'ì£¼ì†Œ ë¯¸ìƒ';
            }

            formatDate(dateStr) {
                if (!dateStr) return 'ë‚ ì§œë¯¸ì •';
                let s = dateStr.toString().trim();
                if (s.length === 6 && !s.includes('-')) {
                    return s.substring(0, 4) + '-' + s.substring(4);
                }
                return s;
            }

            processTop42() {
                const topApts = this.data.apt.sort((a, b) => {
                    const sizeA = parseInt((a['ì„¸ëŒ€ìˆ˜']||'0').replace(/,/g,''));
                    const sizeB = parseInt((b['ì„¸ëŒ€ìˆ˜']||'0').replace(/,/g,''));
                    return sizeB - sizeA;
                }).slice(0, 42);

                this.updateMap(topApts, this.data.agent);
                this.updateList(topApts);
            }

            updateMap(apts, agents) {
                this.markers.forEach(m => m.setMap(null));
                this.markers = [];
                const bounds = new naver.maps.LatLngBounds();
                let hasPoint = false;

                // 1. í•˜ì´ë§ˆíŠ¸ (ì•ˆì‹¬ì¼€ì–´ ì—¬ë¶€ í™•ì¸)
                this.data.himart.forEach(item => {
                    const pos = this.getPos(item);
                    if(!pos) return;
                    
                    // ì•ˆì‹¬ì¼€ì–´ ì—¬ë¶€ í™•ì¸ (Fì—´ ì¶”ì •, í—¤ë”ì— 'ì•ˆì‹¬' í¬í•¨ ì—¬ë¶€)
                    let isSpecial = false;
                    const specialKey = Object.keys(item).find(k => k.includes('ì•ˆì‹¬') || k.includes('ì „ë¬¸'));
                    if (specialKey && (item[specialKey] === 'O' || item[specialKey] === 'Y' || item[specialKey] === 'TRUE')) {
                        isSpecial = true;
                    }

                    // ìƒ‰ìƒ ë° ìŠ¤íƒ€ì¼ ê²°ì •
                    const bgColor = isSpecial ? '#FFD700' : '#E30613'; // ë…¸ë‘ vs ë¹¨ê°•
                    const textColor = isSpecial ? '#000' : '#fff';     // ê²€ì • vs í°ìƒ‰
                    const zIndex = isSpecial ? 120 : 110;              // ë…¸ë‘ì´ ë” ìœ„ë¡œ

                    // ë°˜ê²½
                    new naver.maps.Circle({
                        map: this.map, center: pos, radius: 2000,
                        fillColor: bgColor, fillOpacity: 0.1, strokeColor: bgColor, strokeOpacity: 0.5, strokeWeight: 1, clickable: false
                    });

                    // ë§ˆì»¤
                    const m = new naver.maps.Marker({
                        position: pos, map: this.map, zIndex: zIndex,
                        icon: {
                            content: `<div style="background:${bgColor}; width:24px; height:24px; border-radius:50%; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3); text-align:center; color:${textColor}; font-weight:bold; font-size:14px; line-height:22px;">H</div>`,
                            anchor: new naver.maps.Point(12, 12)
                        }
                    });
                    naver.maps.Event.addListener(m, 'click', () => {
                        this.showInfo('himart', item, m);
                        this.map.panTo(pos);
                        this.map.setZoom(15, true);
                    });
                    this.markers.push(m);
                });

                // 2. ì•„íŒŒíŠ¸ (Top 42)
                apts.forEach(item => {
                    const pos = this.getPos(item);
                    if(!pos) return;
                    const m = new naver.maps.Marker({
                        position: pos, map: this.map,
                        icon: {
                            content: '<div style="font-size:20px; background:white; border-radius:50%; width:28px; height:28px; display:flex; justify-content:center; align-items:center; border:2px solid #F39C12; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">ğŸ¢</div>',
                            anchor: new naver.maps.Point(14, 14)
                        }
                    });
                    item._marker = m; // ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì—°ë™ìš©
                    naver.maps.Event.addListener(m, 'click', () => {
                        this.showInfo('apt', item, m);
                        this.map.panTo(pos);
                        this.map.setZoom(16, true);
                    });
                    this.markers.push(m);
                    bounds.extend(pos);
                    hasPoint = true;
                });

                // 3. ì¤‘ê°œì‚¬
                agents.forEach(item => {
                    const pos = this.getPos(item);
                    if(!pos) return;
                    const m = new naver.maps.Marker({
                        position: pos, map: this.map, zIndex: 100,
                        icon: {
                            content: '<div style="background:#007bff; width:14px; height:14px; border-radius:50%; border:2px solid white; box-shadow:0 1px 3px rgba(0,0,0,0.4);"></div>',
                            anchor: new naver.maps.Point(7, 7)
                        }
                    });
                    naver.maps.Event.addListener(m, 'click', () => {
                        this.showInfo('agent', item, m);
                        this.map.panTo(pos);
                        this.map.setZoom(17, true);
                    });
                    this.markers.push(m);
                });

                if(hasPoint) this.map.fitBounds(bounds);
            }

            showInfo(type, data, marker) {
                let html = '';
                if(type === 'agent') {
                    // ìœ ì—°í•œ ë°ì´í„° ë§¤ì¹­
                    const keys = Object.keys(data);
                    const name = data['ì¤‘ê°œì—…ì†Œëª…'] || data['ë¶€ë™ì‚°ëª…'] || Object.values(data)[1]; 
                    const addr = this.findAddress(data);
                    const phone = data['ì—°ë½ì²˜'] || data['ì „í™”ë²ˆí˜¸'] || Object.values(data)[8] || '-';
                    const manager = data['ì„±í•¨'] || data['ë‹´ë‹¹ì'] || data['ëŒ€í‘œì'] || Object.values(data)[12] || '-';

                    html = `
                        <div class="iw_inner">
                            <div class="iw_title">${name}</div>
                            <div class="iw_row"><div class="iw_icon">ğŸ“</div> <div>${addr}</div></div>
                            <div class="iw_row"><div class="iw_icon">ğŸ“</div> <div><a href="tel:${phone}">${phone}</a></div></div>
                            <div class="iw_row"><div class="iw_icon">ğŸ‘¤</div> <div>ë‹´ë‹¹ì: <b>${manager}</b></div></div>
                        </div>
                    `;
                } else if(type === 'apt') {
                    const dateStr = this.formatDate(data['ì—°ì›”']);
                    const addr = this.findAddress(data);
                    html = `
                        <div class="iw_inner">
                            <div class="iw_title" style="color:#F39C12; border-color:#F39C12;">${data['ì£¼íƒëª…']}</div>
                            <div class="iw_row"><div class="iw_icon">ğŸ </div> <div>${data['ì„¸ëŒ€ìˆ˜']}ì„¸ëŒ€ (${dateStr})</div></div>
                            <div class="iw_row"><div class="iw_icon">ğŸ“</div> <div>${addr}</div></div>
                        </div>
                    `;
                } else {
                    const addr = this.findAddress(data);
                    const name = data['ì§€ì ëª…'] || 'í•˜ì´ë§ˆíŠ¸';
                    // ì•ˆì‹¬ì¼€ì–´ ì„¼í„°ì¸ì§€ í‘œì‹œ
                    let badge = '';
                    const specialKey = Object.keys(data).find(k => k.includes('ì•ˆì‹¬') || k.includes('ì „ë¬¸'));
                    if (specialKey && (data[specialKey] === 'O' || data[specialKey] === 'Y')) {
                        badge = '<span style="background:#FFD700; color:#000; font-size:11px; padding:2px 5px; border-radius:4px; margin-left:5px;">ì•ˆì‹¬ì¼€ì–´</span>';
                    }

                    html = `
                        <div class="iw_inner">
                            <div class="iw_title" style="color:#E30613; border-color:#E30613;">${name} ${badge}</div>
                            <div class="iw_row">ğŸ“ ${addr}</div>
                        </div>
                    `;
                }
                this.infoWindow.setContent(html);
                this.infoWindow.open(this.map, marker);
            }

            updateList(apts) {
                const list = document.getElementById('targetList');
                list.innerHTML = '';

                apts.forEach((item, index) => {
                    const li = document.createElement('li');
                    const dateStr = this.formatDate(item['ì—°ì›”']);
                    const addr = this.findAddress(item);
                    
                    li.innerHTML = `
                        <div style="font-weight:bold; font-size:15px; margin-bottom:5px;">${item['ì£¼íƒëª…']}</div>
                        <div style="font-size:13px; color:#666;">
                            <span>${item['ì„¸ëŒ€ìˆ˜']}ì„¸ëŒ€</span> <span style="margin:0 5px; color:#ddd;">|</span> <span>${dateStr}</span>
                        </div>
                        <div style="font-size:12px; color:#999; margin-top:5px;">${addr}</div>
                        <span class="rank-badge ${index < 3 ? 'top' : ''}">${index + 1}ìœ„</span>
                    `;
                    
                    li.onclick = () => {
                        if(item._marker) {
                            // ë§ˆì»¤ í´ë¦­ íŠ¸ë¦¬ê±° (ì •ë³´ì°½ ì—´ê¸° + ì´ë™)
                            naver.maps.Event.trigger(item._marker, 'click');
                        }
                        document.querySelectorAll('#targetList li').forEach(el => el.classList.remove('active'));
                        li.classList.add('active');
                    };
                    list.appendChild(li);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => { new App(); });
    </script>
</body>
</html>
