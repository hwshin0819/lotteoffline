<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•˜ì´ë§ˆíŠ¸ ì˜ì—… íƒ€ê²ŸíŒ… (Sido Filter & Layout Fix)</title>
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=nrjjvl8zmx"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --himart-color: #E30613;
            --apt-color: #F39C12;
            --agent-color: #007bff;
            --bg-color: #f8f9fa;
        }

        /* ë ˆì´ì•„ì›ƒ ê¹¨ì§ ë°©ì§€: bodyì— flex ì ìš© */
        body { 
            margin: 0; padding: 0; 
            display: flex; 
            height: 100vh; 
            width: 100vw;
            font-family: 'Pretendard', sans-serif; 
            overflow: hidden; 
            background: #f8f9fa; 
        }
        
        /* ì§€ë„ ì˜ì—­: ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ (flex-grow: 1) */
        .map-container { 
            flex-grow: 1; 
            position: relative; 
            height: 100%; 
            /* ìš°ì¸¡ íŒ¨ë„ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ z-index ê´€ë¦¬ */
            z-index: 1; 
        }
        #map { width: 100%; height: 100%; }

        /* ìš°ì¸¡ íŒ¨ë„: ë„ˆë¹„ ê³ ì • (flex-shrink: 0) */
        .sidebar {
            width: 380px; /* ë„ˆë¹„ ê³ ì • */
            flex-shrink: 0; /* ì§€ë„ì— ì˜í•´ ì°Œê·¸ëŸ¬ì§€ì§€ ì•ŠìŒ */
            background: white;
            display: flex; 
            flex-direction: column; 
            z-index: 2; 
            border-left: 1px solid #ddd;
            box-shadow: -2px 0 5px rgba(0,0,0,0.05);
        }

        .sidebar-header { padding: 20px; background: #333; color: white; }
        .sidebar-header h2 { margin: 0 0 5px 0; font-size: 18px; }

        .filter-section { padding: 15px; background: #f1f3f5; border-bottom: 1px solid #ddd; }
        
        select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; background: white; margin-bottom: 5px; cursor: pointer;}

        #targetList { flex: 1; overflow-y: auto; padding: 0; margin: 0; }
        #targetList li {
            list-style: none; padding: 15px; border-bottom: 1px solid #eee;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        #targetList li:hover { background: #f8f9fa; }
        #targetList li.active { background: #e7f5ff; border-left: 4px solid #007bff; }

        .rank-badge {
            position: absolute; top: 15px; right: 15px;
            background: #666; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;
        }
        .rank-badge.top { background: #E30613; }

        /* ë²”ë¡€ */
        .legend {
            position: absolute; top: 20px; left: 20px;
            background: white; padding: 12px 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15); z-index: 100; font-size: 12px;
        }
        .legend-row { display: flex; align-items: center; margin-bottom: 6px; }
        .dot { width: 12px; height: 12px; margin-right: 8px; border-radius: 50%; }

        /* ì •ë³´ì°½ ë””ìì¸ */
        .iw_inner {
            padding: 20px; min-width: 280px; background: white;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid #ddd;
        }
        .iw_title { font-weight: bold; font-size: 17px; margin-bottom: 12px; color: #007bff; border-bottom: 2px solid #f1f3f5; padding-bottom: 8px; }
        .iw_row { font-size: 14px; margin-bottom: 6px; color: #333; display: flex; align-items: flex-start; }
        .iw_icon { width: 20px; text-align: center; margin-right: 8px; }

        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
    </style>
</head>
<body>

    <div id="loading">
        <h3 style="margin-bottom:10px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h3>
        <p style="font-size:12px; color:#666;">í™”ë©´ êµ¬ì„± ë° ì¢Œí‘œ ìµœì í™” ì¤‘</p>
    </div>

    <div class="map-container">
        <div id="map"></div>
        <div class="legend">
            <div class="legend-row">
                <div class="dot" style="background:#007bff; border:2px solid white; box-shadow:0 1px 3px rgba(0,0,0,0.3); width:14px; height:14px;"></div>
                <strong>ì¤‘ê°œì‚¬ë¬´ì†Œ</strong>
            </div>
            <div class="legend-row">
                <div style="font-size:16px; margin-right:5px;">ğŸ¢</div>
                ì…ì£¼ë‹¨ì§€
            </div>
            <div class="legend-row"><div class="dot" style="background:#E30613;"></div>í•˜ì´ë§ˆíŠ¸ (2km)</div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>ì˜ì—… íƒ€ê²Ÿ ëŒ€ì‹œë³´ë“œ</h2>
            <p>ì‹œ/ë„ë³„ í•„í„° & ì„¸ëŒ€ìˆ˜ ë­í‚¹</p>
        </div>
        
        <div class="filter-section">
            <label style="font-size:12px; font-weight:bold; color:#555;">ì§€ì—­ í•„í„° (ì‹œ/ë„)</label>
            <div style="margin-top:5px;">
                <select id="sidoFilter" onchange="app.filterData()"><option value="">ì „êµ­ ë³´ê¸°</option></select>
            </div>
            
            <label style="font-size:12px; font-weight:bold; color:#555; margin-top:10px; display:block;">ê²€ìƒ‰</label>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="text" id="searchInput" placeholder="ì•„íŒŒíŠ¸ëª…, ì¤‘ê°œì‚¬ëª…" 
                       style="padding:10px; width:100%; border:1px solid #ccc; border-radius:4px;"
                       onkeyup="if(event.key==='Enter') app.filterData()">
                <button onclick="app.filterData()" style="width:60px; background:#444; color:white; border:none; border-radius:4px; cursor:pointer;">ì´ë™</button>
            </div>
        </div>

        <div style="padding:10px 15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; font-size:13px; font-weight:bold;">
            <span>íƒ€ê²Ÿ ë¦¬ìŠ¤íŠ¸</span>
            <span id="resultCount" style="color:#007bff;">0ê³³</span>
        </div>
        
        <ul id="targetList"></ul>
    </div>

    <script>
        const URLS = {
            himart: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=0&single=true&output=csv',
            apt: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=412812614&single=true&output=csv', 
            agent: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=222467253&single=true&output=csv'
        };

        class App {
            constructor() {
                this.map = null;
                this.data = { himart: [], apt: [], agent: [] };
                this.markers = [];
                this.infoWindow = null;
                this.initMap();
                this.loadAllData();
            }

            initMap() {
                this.map = new naver.maps.Map('map', {
                    center: new naver.maps.LatLng(37.5665, 126.9780),
                    zoom: 11,
                    scaleControl: true
                });
                this.infoWindow = new naver.maps.InfoWindow({
                    borderWidth: 0, backgroundColor: "transparent", anchorSkew: true, anchorSize: new naver.maps.Size(12, 12)
                });
                naver.maps.Event.addListener(this.map, 'click', () => this.infoWindow.close());
            }

            async loadAllData() {
                try {
                    const [h, a, g] = await Promise.all([
                        this.fetchCSV(URLS.himart), this.fetchCSV(URLS.apt), this.fetchCSV(URLS.agent)
                    ]);
                    this.data = { himart: h, apt: a, agent: g };
                    this.initFilters();
                    this.filterData();
                    document.getElementById('loading').style.display = 'none';
                } catch (e) {
                    alert("ë¡œë”© ì‹¤íŒ¨: " + e.message);
                }
            }

            fetchCSV(url) {
                return new Promise(resolve => {
                    Papa.parse(url, {
                        download: true, header: true, skipEmptyLines: true,
                        transformHeader: h => h.trim(),
                        complete: res => resolve(res.data)
                    });
                });
            }

            getPos(item) {
                let latStr = item['ìœ„ë„'] || item['Yì¢Œí‘œ'] || item['lat'];
                let lngStr = item['ê²½ë„'] || item['Xì¢Œí‘œ'] || item['lng'];
                if(!latStr || !lngStr) return null;
                if(typeof latStr === 'string') latStr = latStr.trim();
                if(typeof lngStr === 'string') lngStr = lngStr.trim();
                let lat = parseFloat(latStr);
                let lng = parseFloat(lngStr);
                if (isNaN(lat) || isNaN(lng)) return null;

                if (lat > 100) { let temp = lat; lat = lng; lng = temp; }
                if (lat > 32 && lat < 43 && lng > 124 && lng < 132) {
                    return new naver.maps.LatLng(lat, lng);
                }
                return null;
            }

            initFilters() {
                // ì‹œ/ë„ í•„í„°ë§Œ ìƒì„±
                const sidoSet = new Set();
                this.data.apt.forEach(d => { if(d['ì‹œë„']) sidoSet.add(d['ì‹œë„']); });
                const sidoSelect = document.getElementById('sidoFilter');
                [...sidoSet].sort().forEach(sido => {
                    const opt = document.createElement('option');
                    opt.value = sido; opt.innerText = sido;
                    sidoSelect.appendChild(opt);
                });
            }

            filterData() {
                const sido = document.getElementById('sidoFilter').value;
                const keyword = document.getElementById('searchInput').value.toLowerCase();

                // 1. ì•„íŒŒíŠ¸ í•„í„°ë§ (ì‹œë„ ê¸°ì¤€)
                const filteredApt = this.data.apt.filter(item => {
                    const addr = (item['ì£¼ì†Œ'] || '').toLowerCase();
                    const itemSido = item['ì‹œë„'] || '';
                    
                    // ì‹œë„ í•„í„° (ì„ íƒ ì•ˆí•˜ë©´ ì „ì²´, ì„ íƒí•˜ë©´ í•´ë‹¹ ì‹œë„)
                    const matchSido = sido ? (itemSido.includes(sido) || addr.includes(sido)) : true;
                    const matchKey = keyword ? (item['ì£¼íƒëª…']||'').toLowerCase().includes(keyword) : true;
                    return matchSido && matchKey;
                }).sort((a, b) => {
                    // ì„¸ëŒ€ìˆ˜ ë­í‚¹ ì •ë ¬
                    const sizeA = parseInt((a['ì„¸ëŒ€ìˆ˜']||'0').replace(/,/g,''));
                    const sizeB = parseInt((b['ì„¸ëŒ€ìˆ˜']||'0').replace(/,/g,''));
                    return sizeB - sizeA;
                });

                // 2. ì¤‘ê°œì‚¬ í•„í„°ë§ (ì‹œë„ ê¸°ì¤€)
                const filteredAgent = this.data.agent.filter(item => {
                    const addr = (item['ì „ì²´ ì£¼ì†Œ'] || '').toLowerCase();
                    const matchSido = sido ? addr.includes(sido) : true;
                    const matchKey = keyword ? (item['ì¤‘ê°œì—…ì†Œëª…']||'').toLowerCase().includes(keyword) : true;
                    return matchSido && matchKey;
                });

                this.updateMap(filteredApt, filteredAgent);
                this.updateList(filteredApt);
            }

            updateMap(apts, agents) {
                this.markers.forEach(m => m.setMap(null));
                this.markers = [];
                const bounds = new naver.maps.LatLngBounds();
                let hasPoint = false;

                // 1. í•˜ì´ë§ˆíŠ¸ (H + ë°˜ê²½)
                this.data.himart.forEach(item => {
                    const pos = this.getPos(item);
                    if(!pos) return;
                    
                    new naver.maps.Circle({
                        map: this.map, center: pos, radius: 2000,
                        fillColor: '#E30613', fillOpacity: 0.1, strokeColor: '#E30613', strokeOpacity: 0.5, strokeWeight: 1, clickable: false
                    });
                    const m = new naver.maps.Marker({
                        position: pos, map: this.map,
                        icon: {
                            content: '<div style="background:#E30613; width:24px; height:24px; border-radius:50%; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3); text-align:center; color:white; font-weight:bold; font-size:14px; line-height:22px;">H</div>',
                            anchor: new naver.maps.Point(12, 12)
                        }
                    });
                    naver.maps.Event.addListener(m, 'click', () => {
                        this.showInfo('himart', item, m);
                        this.map.panTo(pos);
                        this.map.setZoom(16, true);
                    });
                    this.markers.push(m);
                });

                // 2. ì•„íŒŒíŠ¸ (ğŸ¢ ì•„ì´ì½˜)
                apts.forEach(item => {
                    const pos = this.getPos(item);
                    if(!pos) return;
                    const m = new naver.maps.Marker({
                        position: pos, map: this.map,
                        icon: {
                            content: '<div style="font-size:20px; background:white; border-radius:50%; width:28px; height:28px; display:flex; justify-content:center; align-items:center; border:2px solid #F39C12; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">ğŸ¢</div>',
                            anchor: new naver.maps.Point(14, 14)
                        }
                    });
                    naver.maps.Event.addListener(m, 'click', () => {
                        this.showInfo('apt', item, m);
                        this.map.panTo(pos);
                        this.map.setZoom(16, true);
                    });
                    this.markers.push(m);
                    bounds.extend(pos);
                    hasPoint = true;
                });

                // 3. ì¤‘ê°œì‚¬ (ğŸ”µ íŒŒë€ ì›í˜• ë§ˆì»¤ - ìš”ì²­ ë°˜ì˜)
                agents.forEach(item => {
                    const pos = this.getPos(item);
                    if(!pos) return;
                    const m = new naver.maps.Marker({
                        position: pos, map: this.map, zIndex: 100,
                        icon: {
                            // ğŸ”µ íŒŒë€ìƒ‰ ì›
                            content: '<div style="background:#007bff; width:14px; height:14px; border-radius:50%; border:2px solid white; box-shadow:0 1px 3px rgba(0,0,0,0.4);"></div>',
                            anchor: new naver.maps.Point(7, 7)
                        }
                    });
                    naver.maps.Event.addListener(m, 'click', () => {
                        this.showInfo('agent', item, m);
                        this.map.panTo(pos);
                        this.map.setZoom(16, true); // í´ë¦­ ì‹œ ì¤Œì¸
                    });
                    this.markers.push(m);
                    bounds.extend(pos);
                    hasPoint = true;
                });

                if(hasPoint) this.map.fitBounds(bounds);
            }

            showInfo(type, data, marker) {
                let html = '';
                if(type === 'agent') {
                    const name = data['ì¤‘ê°œì—…ì†Œëª…'] || data['ë¶€ë™ì‚°ëª…'];
                    const addr = data['ì „ì²´ ì£¼ì†Œ'] || data['ì£¼ì†Œ'];
                    const phone = data['ì—°ë½ì²˜'] || data['ì „í™”ë²ˆí˜¸'];
                    const manager = data['ì„±í•¨'] || data['ë‹´ë‹¹ì'];

                    html = `
                        <div class="iw_inner">
                            <div class="iw_title">${name}</div>
                            <div class="iw_row"><div class="iw_icon">ğŸ“</div> <div>${addr}</div></div>
                            <div class="iw_row"><div class="iw_icon">ğŸ“</div> <div><a href="tel:${phone}">${phone}</a></div></div>
                            <div class="iw_row"><div class="iw_icon">ğŸ‘¤</div> <div>ë‹´ë‹¹ì: <b>${manager}</b></div></div>
                        </div>
                    `;
                } else if(type === 'apt') {
                    html = `
                        <div class="iw_inner">
                            <div class="iw_title" style="color:#F39C12; border-color:#F39C12;">${data['ì£¼íƒëª…']}</div>
                            <div class="iw_row"><div class="iw_icon">ğŸ </div> <div>${data['ì„¸ëŒ€ìˆ˜']}ì„¸ëŒ€ (${data['ì—°ì›”']})</div></div>
                            <div class="iw_row"><div class="iw_icon">ğŸ“</div> <div>${data['ì£¼ì†Œ']}</div></div>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="iw_inner">
                            <div class="iw_title" style="color:#E30613; border-color:#E30613;">${data['ì§€ì ëª…']}</div>
                            <div class="iw_row">ğŸ“ ${data['ì£¼ì†Œ']}</div>
                        </div>
                    `;
                }
                this.infoWindow.setContent(html);
                this.infoWindow.open(this.map, marker);
            }

            updateList(apts) {
                const list = document.getElementById('targetList');
                const count = document.getElementById('resultCount');
                list.innerHTML = '';
                count.innerText = `${apts.length}ê³³`;

                apts.slice(0, 50).forEach((item, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div style="font-weight:bold; font-size:15px; margin-bottom:5px;">${item['ì£¼íƒëª…']}</div>
                        <div style="font-size:13px; color:#666;">
                            <span>${item['ì„¸ëŒ€ìˆ˜']}ì„¸ëŒ€</span> <span style="margin:0 5px; color:#ddd;">|</span> <span>${item['ì—°ì›”']}</span>
                        </div>
                        <div style="font-size:12px; color:#999; margin-top:5px;">${item['ì£¼ì†Œ']}</div>
                        <span class="rank-badge ${index < 3 ? 'top' : ''}">${index + 1}ìœ„</span>
                    `;
                    li.onclick = () => {
                        const pos = this.getPos(item);
                        if(pos) {
                            this.map.panTo(pos);
                            this.map.setZoom(16, true);
                            document.querySelectorAll('#targetList li').forEach(el => el.classList.remove('active'));
                            li.classList.add('active');
                        }
                    };
                    list.appendChild(li);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => { new App(); });
    </script>
</body>
</html>
