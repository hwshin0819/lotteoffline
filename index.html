<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•˜ì´ë§ˆíŠ¸ ì˜ì—… íƒ€ê²ŸíŒ… (Loan&Biz Ver)</title>
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=nrjjvl8zmx"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* ë¡ ì•¤ë¹„ì¦ˆ ìŠ¤íƒ€ì¼ ë³µì› */
        :root {
            --himart-color: #E30613;
            --apt-color: #F39C12;
            --agent-color: #007bff; /* íŒŒë€ìƒ‰ */
            --bg-color: #e9ecef;
        }

        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Pretendard', sans-serif; overflow: hidden; }
        
        /* ì™¼ìª½ ì§€ë„ ì˜ì—­ */
        .map-container { flex: 3; position: relative; height: 100%; }
        #map { width: 100%; height: 100%; }

        /* ì˜¤ë¥¸ìª½ íŒ¨ë„ */
        .sidebar {
            flex: 1; min-width: 320px; background: #f8f9fa;
            display: flex; flex-direction: column; border-left: 1px solid #ddd;
            box-shadow: -2px 0 5px rgba(0,0,0,0.05); z-index: 2;
        }

        .sidebar-header {
            padding: 20px; background: white; border-bottom: 1px solid #eee;
        }
        .sidebar-header h2 { margin: 0 0 10px 0; font-size: 18px; color: #333; }

        /* ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
        #targetList { flex: 1; overflow-y: auto; padding: 10px; margin: 0; }
        #targetList li {
            list-style: none; background: white; padding: 15px; margin-bottom: 8px;
            border-radius: 8px; border: 1px solid #eee; cursor: pointer;
            transition: all 0.2s;
        }
        #targetList li:hover {
            transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            border-color: var(--agent-color);
        }
        
        .info-label { font-size: 12px; color: #666; margin-top: 4px; }
        .badge { background: #007bff; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; }

        /* ì§€ë„ ìœ„ ë²”ë¡€ */
        .legend {
            position: absolute; top: 20px; left: 20px;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; font-size: 13px; }
        .dot { width: 12px; height: 12px; margin-right: 8px; border-radius: 50%; }

        /* ì •ë³´ì°½ (InfoWindow) ìŠ¤íƒ€ì¼ */
        .iw-container { padding: 15px; min-width: 250px; background: white; border-radius: 8px; }
        .iw-title { font-weight: bold; font-size: 16px; margin-bottom: 8px; color: #333; padding-bottom: 5px; border-bottom: 2px solid #007bff; }
        .iw-row { margin-bottom: 4px; font-size: 13px; color: #555; }
        
        /* ë¡œë”©ë°” */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center;
            z-index: 9999; font-weight: bold;
        }

        input, select, button { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ddd; }
        button { background: #333; color: white; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="map-container">
        <div id="map"></div>
        <div class="legend">
            <div class="legend-item">
                <div style="width:0; height:0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 10px solid #007bff; margin-right:8px;"></div>
                ì¤‘ê°œì‚¬ë¬´ì†Œ (íƒ€ê²Ÿ)
            </div>
            <div class="legend-item"><div class="dot" style="background:var(--apt-color); border-radius:0;"></div>ì…ì£¼ë‹¨ì§€</div>
            <div class="legend-item"><div class="dot" style="background:var(--himart-color)"></div>í•˜ì´ë§ˆíŠ¸</div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>í•˜ì´ë§ˆíŠ¸ ì˜ì—… íƒ€ê²ŸíŒ…</h2>
            <select id="dataFilter" onchange="app.filterList()">
                <option value="all">ì „ì²´ ë³´ê¸°</option>
                <option value="apt">ì…ì£¼ë‹¨ì§€ ì¤‘ì‹¬</option>
                <option value="agent">ì¤‘ê°œì‚¬ ì¤‘ì‹¬</option>
            </select>
            <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ (ì•„íŒŒíŠ¸ëª…, ì§€ì—­ëª…)" onkeyup="if(event.key==='Enter') app.filterList()">
            <button onclick="app.filterList()">ê²€ìƒ‰</button>
            <div id="count" style="font-size:13px; color:#666; text-align:right;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
        </div>
        <ul id="targetList"></ul>
    </div>

    <div id="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>

    <script>
        // âœ… ë°ì´í„° ë§í¬ (ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”)
        const URLS = {
            himart: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=0&single=true&output=csv',
            apt: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=412812614&single=true&output=csv', 
            agent: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcOgR-HcluU57Cp9eXXSEsM8eU9wC_OvCEMktuZpofT0cNZRw18ZDRUBpqDXygA_nMucWIMmN0Uq35/pub?gid=222467253&single=true&output=csv'
        };

        class App {
            constructor() {
                this.map = null;
                this.markers = [];
                this.infoWindow = null;
                this.data = { himart: [], apt: [], agent: [] };
                
                this.initMap();
                this.loadData();
            }

            initMap() {
                this.map = new naver.maps.Map('map', {
                    center: new naver.maps.LatLng(37.5665, 126.9780),
                    zoom: 12,
                    scaleControl: true,
                    logoControl: false
                });

                // ì •ë³´ì°½ ì´ˆê¸°í™” (íˆ¬ëª… ë°°ê²½ìœ¼ë¡œ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ì ìš©)
                this.infoWindow = new naver.maps.InfoWindow({
                    borderWidth: 0,
                    backgroundColor: "transparent",
                    anchorSkew: true,
                    anchorSize: new naver.maps.Size(12, 12)
                });

                // ì§€ë„ ë¹ˆ ê³³ í´ë¦­ ì‹œ ì •ë³´ì°½ ë‹«ê¸°
                naver.maps.Event.addListener(this.map, 'click', () => {
                    this.infoWindow.close();
                });
            }

            async loadData() {
                try {
                    const [h, a, g] = await Promise.all([
                        this.fetchCSV(URLS.himart),
                        this.fetchCSV(URLS.apt),
                        this.fetchCSV(URLS.agent)
                    ]);
                    
                    this.data = { himart: h, apt: a, agent: g };
                    console.log("ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", this.data);
                    
                    this.drawMarkers();
                    this.filterList(); // ì´ˆê¸° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                    
                    document.getElementById('loading').style.display = 'none';
                } catch (e) {
                    alert("ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                }
            }

            fetchCSV(url) {
                return new Promise(resolve => {
                    Papa.parse(url, {
                        download: true, header: true, skipEmptyLines: true,
                        complete: res => resolve(res.data)
                    });
                });
            }

            // ì¢Œí‘œ ì¶”ì¶œ (ìœ„ë„/ê²½ë„, Yì¢Œí‘œ/Xì¢Œí‘œ ëª¨ë‘ ëŒ€ì‘)
            getPos(item) {
                const lat = item['ìœ„ë„'] || item['Yì¢Œí‘œ'];
                const lng = item['ê²½ë„'] || item['Xì¢Œí‘œ'];
                if(lat && lng) return new naver.maps.LatLng(lat, lng);
                return null;
            }

            drawMarkers() {
                // 1. í•˜ì´ë§ˆíŠ¸ (ë¹¨ê°„ ì›)
                this.data.himart.forEach(item => {
                    const pos = this.getPos(item);
                    if(!pos) return;

                    // ë°˜ê²½
                    new naver.maps.Circle({
                        map: this.map, center: pos, radius: 2000,
                        fillColor: '#E30613', fillOpacity: 0.05,
                        strokeColor: '#E30613', strokeOpacity: 0.2, clickable: false
                    });

                    // ë§ˆì»¤
                    const marker = new naver.maps.Marker({
                        position: pos, map: this.map,
                        icon: {
                            content: '<div style="background:#E30613; width:22px; height:22px; border-radius:50%; border:2px solid white; box-shadow:0 2px 4px rgba(0,0,0,0.3); color:white; font-weight:bold; text-align:center; font-size:12px; line-height:18px;">H</div>',
                            anchor: new naver.maps.Point(11, 11)
                        }
                    });
                    
                    // í´ë¦­ ì´ë²¤íŠ¸
                    naver.maps.Event.addListener(marker, 'click', () => {
                        this.showInfo(marker, 'himart', item);
                        this.panTo(pos);
                    });
                });

                // 2. ì•„íŒŒíŠ¸ (ì£¼í™©ìƒ‰ ë„¤ëª¨)
                this.data.apt.forEach(item => {
                    const pos = this.getPos(item);
                    if(!pos) return;

                    const marker = new naver.maps.Marker({
                        position: pos, map: this.map,
                        icon: {
                            content: '<div style="background:#F39C12; width:16px; height:16px; border:2px solid white; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                            anchor: new naver.maps.Point(8, 8)
                        }
                    });

                    naver.maps.Event.addListener(marker, 'click', () => {
                        this.showInfo(marker, 'apt', item);
                        this.panTo(pos);
                    });
                });

                // 3. ì¤‘ê°œì‚¬ (íŒŒë€ í•€ - ë¡ ì•¤ë¹„ì¦ˆ ìŠ¤íƒ€ì¼)
                this.data.agent.forEach(item => {
                    const pos = this.getPos(item);
                    if(!pos) return;

                    const marker = new naver.maps.Marker({
                        position: pos, map: this.map, zIndex: 100,
                        icon: {
                            // í•€ ëª¨ì–‘ HTML
                            content: `
                                <div style="position:relative;">
                                    <div style="background:#007bff; width:32px; height:32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border:2px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center;">
                                        <div style="width:10px; height:10px; background:white; border-radius:50%; transform: rotate(45deg);"></div>
                                    </div>
                                </div>
                            `,
                            anchor: new naver.maps.Point(16, 32)
                        }
                    });

                    naver.maps.Event.addListener(marker, 'click', () => {
                        this.showInfo(marker, 'agent', item);
                        this.panTo(pos);
                    });
                });
            }

            // ì •ë³´ì°½ ë‚´ìš© ë§Œë“¤ê¸°
            showInfo(marker, type, data) {
                let html = '';
                
                if (type === 'agent') {
                    // ìš”ì²­í•˜ì‹  ì •í™•í•œ í¬ë§·
                    html = `
                        <div class="iw-container">
                            <div class="iw-title">${data['ì¤‘ê°œì—…ì†Œëª…']}</div>
                            <div class="iw-row">ğŸ“ ${data['ì „ì²´ ì£¼ì†Œ']}</div>
                            <div class="iw-row">ğŸ“ ${data['ì—°ë½ì²˜']}</div>
                            <div class="iw-row" style="margin-top:8px; font-weight:bold; color:#333;">ğŸ‘¤ ë‹´ë‹¹ì: ${data['ì„±í•¨']}</div>
                        </div>
                    `;
                } else if (type === 'apt') {
                    html = `
                        <div class="iw-container">
                            <div class="iw-title" style="border-color:#F39C12;">${data['ì£¼íƒëª…']}</div>
                            <div class="iw-row">ğŸ  ${data['ì„¸ëŒ€ìˆ˜']}ì„¸ëŒ€ | ${data['ì—°ì›”']}</div>
                            <div class="iw-row">ğŸ“„ ë§¤ë§¤ ${data['ë§¤ë§¤']} / ì „ì„¸ ${data['ì „ì„¸']}</div>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="iw-container">
                            <div class="iw-title" style="border-color:#E30613;">${data['ì§€ì ëª…']}</div>
                            <div class="iw-row">ğŸ“ ${data['ì£¼ì†Œ']}</div>
                            <div class="iw-row">ğŸ“ ${data['ì „í™”ë²ˆí˜¸'] || 'ì „í™”ë²ˆí˜¸ ì—†ìŒ'}</div>
                        </div>
                    `;
                }

                this.infoWindow.setContent(html);
                this.infoWindow.open(this.map, marker);
            }

            // ì§€ë„ ì´ë™ ë° ì¤Œ
            panTo(pos) {
                this.map.panTo(pos, { duration: 300 });
                this.map.setZoom(15, true);
            }

            // ìš°ì¸¡ íŒ¨ë„ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
            filterList() {
                const keyword = document.getElementById('searchInput').value.toLowerCase();
                const type = document.getElementById('dataFilter').value;
                const list = document.getElementById('targetList');
                list.innerHTML = '';
                
                let count = 0;
                
                // ì¤‘ê°œì‚¬ ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
                if (type === 'all' || type === 'agent') {
                    this.data.agent.forEach(item => {
                        if (count > 50) return; // ì„±ëŠ¥ ìœ„í•´ 50ê°œ ì œí•œ
                        if (item['ì¤‘ê°œì—…ì†Œëª…'].includes(keyword) || item['ì „ì²´ ì£¼ì†Œ'].includes(keyword)) {
                            this.createListItem(list, item, 'agent');
                            count++;
                        }
                    });
                }

                // ì•„íŒŒíŠ¸ ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
                if (type === 'all' || type === 'apt') {
                    this.data.apt.forEach(item => {
                        if (count > 100) return;
                        if (item['ì£¼íƒëª…'].includes(keyword)) {
                            this.createListItem(list, item, 'apt');
                            count++;
                        }
                    });
                }

                document.getElementById('count').innerText = `ê²€ìƒ‰ ê²°ê³¼: ${count}ê°œ`;
            }

            createListItem(parent, item, type) {
                const li = document.createElement('li');
                if (type === 'agent') {
                    li.innerHTML = `
                        <div style="font-weight:bold; color:#007bff;">${item['ì¤‘ê°œì—…ì†Œëª…']}</div>
                        <div class="info-label">${item['ì „ì²´ ì£¼ì†Œ']}</div>
                        <div class="info-label">ğŸ‘¤ ${item['ì„±í•¨']}</div>
                    `;
                } else {
                    li.innerHTML = `
                        <div style="font-weight:bold; color:#F39C12;">${item['ì£¼íƒëª…']}</div>
                        <div class="info-label">${item['ì„¸ëŒ€ìˆ˜']}ì„¸ëŒ€ | ${item['ì—°ì›”']}</div>
                    `;
                }
                
                li.onclick = () => {
                    const pos = this.getPos(item);
                    if (pos) {
                        this.panTo(pos);
                        // í•´ë‹¹ ìœ„ì¹˜ì˜ ë§ˆì»¤ì— íŠ¸ë¦¬ê±°ë¥¼ ì¤„ ìˆ˜ë„ ìˆì§€ë§Œ, ì¼ë‹¨ ì´ë™ë§Œ ì²˜ë¦¬
                    }
                };
                parent.appendChild(li);
            }
        }

        const app = new App();
    </script>
</body>
</html>
